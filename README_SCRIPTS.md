# 自动化启动脚本说明

本项目提供了多个批处理脚本，用于简化PBFT节点的启动和管理。

## 📋 脚本列表

### 1. `build.bat` - 编译项目
编译主程序和客户端。

**使用方法：**
```bash
build.bat
```

**功能：**
- 编译 `pbftdidchain.exe`（主程序）
- 编译 `test/client.exe`（客户端）

---

### 2. `start_nodes.bat` - 启动所有节点
在新窗口中启动所有4个PBFT节点。

**使用方法：**
```bash
start_nodes.bat
```

**功能：**
- 自动启动节点0、1、2、3
- 每个节点在独立的命令窗口运行
- 自动检查可执行文件是否存在

**注意事项：**
- 启动后需要等待所有节点连接成功
- 每个节点窗口标题会显示节点ID

---

### 3. `start_client.bat` - 启动客户端
启动测试客户端，向主节点发送请求。

**使用方法：**
```bash
start_client.bat [主节点ID]
```

**参数：**
- `主节点ID`（可选）：默认为0，指定要连接的主节点ID

**示例：**
```bash
start_client.bat 0    # 连接到节点0（默认）
start_client.bat 1    # 连接到节点1
```

**功能：**
- 自动检查并编译客户端（如果不存在）
- 在新窗口中启动客户端

---

### 4. `start_all.bat` - 一键启动
一键启动所有节点，并可选择启动客户端。

**使用方法：**
```bash
start_all.bat
```

**功能：**
- 自动启动所有4个节点
- 等待5秒让节点连接
- 询问是否启动客户端

---

### 5. `stop_all.bat` - 停止所有进程
停止所有PBFT相关的进程。

**使用方法：**
```bash
stop_all.bat
```

**功能：**
- 停止所有 `pbftdidchain.exe` 进程
- 停止所有 `client.exe` 进程
- 关闭所有PBFT相关窗口

---

## 🚀 快速开始

### 方法一：使用一键启动脚本（推荐）

```bash
# 1. 编译项目（首次运行）
build.bat

# 2. 一键启动所有节点
start_all.bat
```

### 方法二：分步启动

```bash
# 1. 编译项目
build.bat

# 2. 启动所有节点
start_nodes.bat

# 3. 等待节点连接成功后，启动客户端
start_client.bat 0

# 4. 停止所有进程（完成后）
stop_all.bat
```

---

## 📝 使用示例

### 完整测试流程

```bash
# 步骤1: 编译项目
build.bat

# 步骤2: 启动所有节点
start_nodes.bat

# 步骤3: 等待10-15秒，确保所有节点连接成功
# （观察节点窗口，应该看到类似 "node [X] connected" 的消息）

# 步骤4: 启动客户端测试
start_client.bat 0

# 步骤5: 观察输出
# - 节点窗口：显示共识消息
# - 客户端窗口：显示 "Consensus(seq=X) operation(1) success!"

# 步骤6: 测试完成后停止所有进程
stop_all.bat
```

---

## ⚠️ 注意事项

1. **端口占用**：确保端口30000-30003和8088未被占用
   ```bash
   # 检查端口占用
   netstat -ano | findstr :30000
   ```

2. **防火墙**：如果节点无法连接，检查Windows防火墙设置

3. **节点顺序**：建议先启动节点0（主节点），再启动其他节点

4. **编译要求**：首次运行前必须执行 `build.bat` 编译项目

5. **停止进程**：测试完成后使用 `stop_all.bat` 清理所有进程

---

## 🔧 故障排除

### 问题1：找不到可执行文件
**解决：** 运行 `build.bat` 编译项目

### 问题2：端口被占用
**解决：** 
```bash
# 查看占用端口的进程
netstat -ano | findstr :30000

# 结束进程（替换PID）
taskkill /PID <进程ID> /F
```

### 问题3：节点无法连接
**解决：**
- 检查所有节点是否都已启动
- 检查防火墙设置
- 确保节点ID正确（0, 1, 2, 3）

### 问题4：客户端收不到回复
**解决：**
- 确保至少3个节点正常运行
- 检查主节点是否正常运行
- 查看节点日志确认请求是否被接收

---

## 📌 脚本位置

所有脚本位于项目根目录：
```
pbftdidchain/
├── build.bat          # 编译脚本
├── start_nodes.bat    # 启动节点
├── start_client.bat   # 启动客户端
├── start_all.bat      # 一键启动
└── stop_all.bat       # 停止所有进程
```

---

## 💡 提示

- 所有脚本都支持中文显示（UTF-8编码）
- 节点窗口标题会显示节点ID，方便识别
- 使用 `stop_all.bat` 可以快速清理所有进程
- 建议在测试前先检查端口是否可用

